<!DOCTYPE html>
<html>
<head>
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,700' rel='stylesheet' type='text/css'>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
<link rel="stylesheet" href="https://skiadas.github.io/css/course.css" type="text/css" />

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</head>
<body>
<section id="lab-introduction-to-ggplot" class="level1">
<h1>Lab: Introduction to ggplot</h1>
<section id="introduction" class="level2">
<h2>Introduction</h2>
<p>In this lab we will delve more deeply into the <a href="https://ggplot2.tidyverse.org/">ggplot2</a> graphics package and how we can use it to create elaborate graphs.</p>
<p><code>ggplot2</code> builds on the idea of a <a href="http://vita.had.co.nz/papers/layered-grammar.html">grammar of graphics</a>. The basic concept in the grammar of graphics is that we build a graph iteratively by specifying various components of it:</p>
<ul>
<li>We start by specifying the <strong>data</strong> for it. That would be a data frame.</li>
<li>We use <strong>aesthetics</strong> to determine which variables will be shown on the graph and how. For example one variable could be assigned to correspond to the x axis, another to correspond to a color, one to correspond to size and so on.</li>
<li>We use <strong>geometries</strong>, usually abbreviated as <strong>geom</strong>s to determine the kinds of shapes we want to have included in the graph (points, lines, bars etc). We can have multiple geoms on the same graph, creating various layers.</li>
<li>We use <strong>stats</strong> to determine what statistic of the variable will be visualized. This often is done at the same time as specifying a geom, but it can also be done separately.</li>
<li>We get to specify a <strong>facet</strong> to create separate panels based on values of one or more discrete variables.</li>
<li>We can use <strong>scales</strong> to control how data values are mapped to visual values. Often default scales work just fine.</li>
<li>We can use <strong>annotations</strong> to add text and similar elements to a graph.</li>
<li>We use <strong>themes</strong> to control the overall graph appearance (axes ticks, labels, legend etc).</li>
</ul>
<p>This will make more sense as we move along.</p>
<p>You can load <code>ggplot2</code> itself directly, or you can load it as part of the <code>hanoverbase</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(hanoverbase)</code></pre></div>
</section>
<section id="a-first-example-color-vs-price-for-diamonds" class="level2">
<h2>A first example: Color vs Price for diamonds</h2>
<p>We will use the built-in <code>diamonds</code> data for this lab.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(diamonds)
<span class="kw">View</span>(diamonds)   <span class="co"># Do the View in the console</span>
?diamonds        <span class="co"># If you want to open up the dataset documentation</span></code></pre></div>
<p>We would like to investigate how the color relates to the price of the diamonds. We start by defining the dataset to use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds)</code></pre></div>
<p>This will not show much (and empty plot), but it tells ggplot to use the <code>diamonds</code> dataset. Next we will specify the “aesthetics”: In this case we will tell it to use <code>color</code> for the x axis and <code>price</code> for the y axis:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span><span class="st"> </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price)</code></pre></div>
<p>This should have produced axes, but it has plotted no data yet. This is because we have not specified any geom layer yet. We add this with another “plus”. We will spread this onto a new line to keep the lines short. To do that, you need each previous line to end with the plus.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_boxplot</span>()</code></pre></div>
<p>Note that the price seems to increase as the color gets <em>worse</em> (J is worse than D). This sounds opposite to what it should be, and we’ll examine that later.</p>
<p>For now let us add one more layer, namely a point for each color, representing the mean price:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">fun.y=</span>mean, <span class="dt">color=</span><span class="st">&quot;red&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>, <span class="dt">size=</span><span class="dv">3</span>)</code></pre></div>
<p>We are here telling the graph to add “points” (<code>geom_point</code>) where it uses a specific <code>stat</code> function, namely “summary” which actually calls the function <code>stat_summary</code>. This specifies a statistical summary to compute at each grouping, and <code>fun.y=mean</code> specifies what computation should occur, namely the mean function for each individual color value. The remaining parameters customize the look and feel of the points.</p>
<p>Let’s also add lines connecting the means:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">group=</span><span class="dv">1</span>, <span class="dt">fun.y=</span>mean, <span class="dt">size=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">fun.y=</span>mean, <span class="dt">color=</span><span class="st">&quot;red&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>, <span class="dt">size=</span><span class="dv">3</span>)</code></pre></div>
<p>As the price range is quite skewed, let us adjust the y scale to use a logarithmic scale:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">group=</span><span class="dv">1</span>, <span class="dt">fun.y=</span>mean, <span class="dt">size=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">fun.y=</span>mean, <span class="dt">color=</span><span class="st">&quot;red&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>, <span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()</code></pre></div>
<p>This performed a log transform on the prices before it computed the boxplot, then drew a the graph with a logarithmic y-scale but showing the actual price values there.</p>
<p>Next, let us specify some tick marks. We do this by setting the <code>breaks</code> parameter of the scale transform:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">group=</span><span class="dv">1</span>, <span class="dt">fun.y=</span>mean, <span class="dt">size=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">fun.y=</span>mean, <span class="dt">color=</span><span class="st">&quot;red&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>, <span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">3000</span>, <span class="dv">5000</span>, <span class="dv">70000</span>, <span class="dv">9000</span>, <span class="dv">11000</span>, <span class="dv">13000</span>))</code></pre></div>
<p>Now, let us use a custom theme to change the look and feel of the graph We’ll remove the vertical grid lines, set the background to while and the horizontal grid lines to light green:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">group=</span><span class="dv">1</span>, <span class="dt">fun.y=</span>mean, <span class="dt">size=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">fun.y=</span>mean, <span class="dt">color=</span><span class="st">&quot;red&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>, <span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">3000</span>, <span class="dv">5000</span>, <span class="dv">70000</span>, <span class="dv">9000</span>, <span class="dv">11000</span>, <span class="dv">13000</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_light</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(
        <span class="dt">panel.grid.major.y =</span> <span class="kw">element_line</span>(<span class="dt">color=</span><span class="st">&quot;lightgreen&quot;</span>),
        <span class="dt">panel.grid.major.x =</span> <span class="kw">element_blank</span>()
    )</code></pre></div>
<p>It’s worth mentioning that you can save any part of this graph-building, and reuse it in other graphs. For example, we can create our own theme and store in a variable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ourTheme &lt;-<span class="st"> </span><span class="kw">theme_light</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(
        <span class="dt">panel.grid.major.y =</span> <span class="kw">element_line</span>(<span class="dt">color=</span><span class="st">&quot;lightgreen&quot;</span>),
        <span class="dt">panel.grid.major.x =</span> <span class="kw">element_blank</span>()
    )

<span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">group=</span><span class="dv">1</span>, <span class="dt">fun.y=</span>mean, <span class="dt">size=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">fun.y=</span>mean, <span class="dt">color=</span><span class="st">&quot;red&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>, <span class="dt">size=</span><span class="dv">3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">3000</span>, <span class="dv">5000</span>, <span class="dv">70000</span>, <span class="dv">9000</span>, <span class="dv">11000</span>, <span class="dv">13000</span>)) <span class="op">+</span>
<span class="st">    </span>ourTheme</code></pre></div>
<p>We can also save our own boxplot with the extra mean lines added. For that we will need to to store the three components that we want to include into a list. ggplot2 will unpack the list and put the components with pluses:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">boxplotWithMeans &lt;-<span class="st"> </span><span class="kw">list</span>(
    <span class="kw">geom_boxplot</span>(),
    <span class="kw">geom_line</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">group=</span><span class="dv">1</span>, <span class="dt">fun.y=</span>mean, <span class="dt">size=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="st">&quot;dashed&quot;</span>),
    <span class="kw">geom_point</span>(<span class="dt">stat=</span><span class="st">&quot;summary&quot;</span>, <span class="dt">fun.y=</span>mean, <span class="dt">color=</span><span class="st">&quot;red&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>, <span class="dt">size=</span><span class="dv">3</span>)
)

priceLogScale &lt;-<span class="st"> </span><span class="kw">scale_y_log10</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">3000</span>, <span class="dv">5000</span>, <span class="dv">70000</span>, <span class="dv">9000</span>, <span class="dv">11000</span>, <span class="dv">13000</span>))

<span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price) <span class="op">+</span>
<span class="st">    </span>boxplotWithMeans <span class="op">+</span>
<span class="st">    </span>priceLogScale <span class="op">+</span>
<span class="st">    </span>ourTheme</code></pre></div>
<p><strong>Practice</strong>: Do a similar graph to compare price and clarity as well as price and cut. What would be your initial observations about the relations?</p>
</section>
<section id="scatterplots-and-faceting" class="level2">
<h2>Scatterplots and faceting</h2>
<p>Let us now examine the relation between price and carats:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>()</code></pre></div>
<p>This relation will look better in logarithmic scale:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()</code></pre></div>
<p>Let us try to add a transparency to each point:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()</code></pre></div>
<p>Or we can try to use single dots for each point rather than circles:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">shape=</span><span class="st">&quot;.&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()</code></pre></div>
<p>A better approach is to use bin2d:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bin2d</span>(<span class="dt">bins=</span><span class="dv">50</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()</code></pre></div>
<p>Now let us add a linear regression line with error estimates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bin2d</span>(<span class="dt">bins=</span><span class="dv">50</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_lm</span>(<span class="dt">interval=</span><span class="st">&quot;prediction&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()</code></pre></div>
<p>Or we might prefer a “smooth” line fit instead:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bin2d</span>(<span class="dt">bins=</span><span class="dv">50</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">color=</span><span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()</code></pre></div>
<p>We will now use facets to create a panelled graph and investigate this relation based on a third variable (e.g. cut, clarity, or color):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bin2d</span>(<span class="dt">bins=</span><span class="dv">50</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">color=</span><span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>cut)</code></pre></div>
<p>We can do two factors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bin2d</span>(<span class="dt">bins=</span><span class="dv">50</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">color=</span><span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>cut <span class="op">+</span><span class="st"> </span>clarity)</code></pre></div>
<p>With two factors, it is best to use <code>facet_grid</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(carat, price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bin2d</span>(<span class="dt">bins=</span><span class="dv">50</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">color=</span><span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_grid</span>(cut <span class="op">~</span><span class="st"> </span>color) <span class="op">+</span>
<span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Diamond price vs carat separated by cut and color&quot;</span>)</code></pre></div>
<p><strong>Practice</strong>: Use these techniques to compare the width (y) and length (x) of diamonds. You may have to filter the data to get a better view.</p>
</section>
<section id="barcharts-for-categorical-variables" class="level2">
<h2>Barcharts for categorical variables</h2>
<p>We can use barcharts to investigate relations between the categorical variables. Let’s start with individual barcharts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color)</code></pre></div>
<p>Question: How would we add color to the bars?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>color))</code></pre></div>
<p>Let us briefly talk about choosing the color palette to use. This is basically setting a <strong>scale</strong> for the fill variable. It would be a discrete scale. There are four different ways of specifying a discrete color scale:</p>
<ul>
<li>Directly listing the colors: <code>scale_fill_manual(values=c(&quot;blue&quot;, &quot;green&quot;, &quot;orange&quot;, &quot;red&quot;, &quot;magenta&quot;, &quot;purple&quot;, &quot;pink&quot;))</code></li>
<li>Using one of the preset “color brewer” palettes <code>scale_fill_brewer(palette=&quot;Set1&quot;)</code> (see options with <code>display.brewer.all()</code>)</li>
<li>Using a grey-scale: <code>scale_fill_grey(start=0.3, end=0.7)</code></li>
<li>Using a scale based on the HCL color wheel: <code>scale_fill_hue</code></li>
</ul>
<p><strong>Practice</strong>: Try adding one of these now.</p>
<p>Let us compare two categorical variables, say cut and clarity:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">fill=</span>clarity) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>()</code></pre></div>
<p>Let’s make it 100% stacked:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">fill=</span>clarity) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">position=</span><span class="st">&quot;fill&quot;</span>)</code></pre></div>
<p>You can also try to combine this with a facet:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>cut, <span class="dt">fill=</span>clarity) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>color)</code></pre></div>
<p>We can also add lines at the bar locations, to follow the trends:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>cut, <span class="dt">fill=</span>clarity) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>clarity), <span class="dt">stat=</span><span class="st">&quot;count&quot;</span>, <span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>color)</code></pre></div>
<p>We can change the theme to “angle” the x axis labels:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">    </span><span class="kw">aes</span>(<span class="dt">x=</span>cut, <span class="dt">fill=</span>clarity) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>clarity), <span class="dt">stat=</span><span class="st">&quot;count&quot;</span>, <span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>color) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(
        <span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle=</span><span class="op">-</span><span class="dv">45</span>, <span class="dt">vjust=</span><span class="fl">0.5</span>)
    )</code></pre></div>
</section>
<section id="pie-charts" class="level2">
<h2>Pie Charts</h2>
<p>Creating a pie chart is somewhat more elaborate. The main idea is as follows: We create a bar chart of one stacked bar, and then we make a change to polar coordinates, which wraps the y axis into a circle.</p>
<p>On a first step, let us create a bar chart of one stacked bar based on cut. Each bar chart however needs an x variable. We “fake” such a variable by using <code>factor(1)</code>, which creates a single common level (labeled <code>1</code>) for all the data rows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds) <span class="op">+</span>
<span class="st">     </span><span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">factor</span>(<span class="dv">1</span>), <span class="dt">fill=</span>cut) <span class="op">+</span>
<span class="st">     </span><span class="kw">geom_bar</span>()</code></pre></div>
<p>The current graph has extra spaces on the bar sides, which is the default behavior for bar charts as the bars are not supposed to connect to each other. In our case this extra space will present problems when we turn the graph to polar coordinates, we therefore eliminate the space by specifying the bar width. We will also remove the extraneous top and bottom spacing by setting the <code>expand</code> parameter of the <code>y</code> scale:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">factor</span>(<span class="dv">1</span>), <span class="dt">fill=</span>cut)) <span class="op">+</span>
<span class="st">     </span><span class="kw">geom_bar</span>(<span class="dt">width=</span><span class="dv">1</span>) <span class="op">+</span>
<span class="st">     </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</code></pre></div>
<p>Next we will remove the axis labeling and ticks, by specifying a theme:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">factor</span>(<span class="dv">1</span>), <span class="dt">fill=</span>cut)) <span class="op">+</span>
<span class="st">     </span><span class="kw">geom_bar</span>(<span class="dt">width=</span><span class="dv">1</span>) <span class="op">+</span>
<span class="st">     </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span>
<span class="st">     </span><span class="kw">theme_void</span>()</code></pre></div>
<p>Lastly, we turn into polar coordinates. We also add borders to the bars/slices:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ourPieChart &lt;-
<span class="st">     </span><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">factor</span>(<span class="dv">1</span>), <span class="dt">fill=</span>cut)) <span class="op">+</span>
<span class="st">     </span><span class="kw">geom_bar</span>(<span class="dt">width=</span><span class="dv">1</span>, <span class="dt">color=</span><span class="st">&quot;white&quot;</span>, <span class="dt">size=</span><span class="fl">0.2</span>) <span class="op">+</span>
<span class="st">     </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span>
<span class="st">     </span><span class="kw">theme_void</span>() <span class="op">+</span>
<span class="st">     </span><span class="kw">coord_polar</span>(<span class="dt">theta=</span><span class="st">&quot;y&quot;</span>)</code></pre></div>
<p>To add percentages, a lot more work needs to be done. We can obtain the percentages as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diamonds<span class="op">$</span>cut <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">table</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prop.table</span>()</code></pre></div>
<p>To incorporate the percentages as slice labels, we need a bit more work. We start by creating a new data frame that computes the needed counts and proportions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cutCounts &lt;-<span class="st"> </span>diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(cut) <span class="op">%&gt;%</span>
<span class="st">             </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>(), <span class="dt">percent=</span> <span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">n</span>()<span class="op">/</span><span class="kw">nrow</span>(diamonds))
cutCounts</code></pre></div>
<p>We will want to format that percent so that it has fewer digits and a percent symbol after it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cutCounts &lt;-<span class="st"> </span>diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(cut) <span class="op">%&gt;%</span>
<span class="st">             </span><span class="kw">summarize</span>(<span class="dt">count=</span><span class="kw">n</span>(), <span class="dt">percent=</span> <span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">n</span>()<span class="op">/</span><span class="kw">nrow</span>(diamonds)) <span class="op">%&gt;%</span>
<span class="st">             </span><span class="kw">mutate</span>(<span class="dt">percent =</span> <span class="kw">format</span>(percent, <span class="dt">digits =</span> <span class="dv">2</span>)) <span class="op">%&gt;%</span>
<span class="st">             </span><span class="kw">mutate</span>(<span class="dt">percent =</span> <span class="kw">paste</span>(percent, <span class="st">&quot;%&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>))
cutCounts</code></pre></div>
<p>Then we add a new geom to our graph, which draws from a specific dataset rather than the dataset used in the pie chart:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ourPieChart <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data=</span>cutCounts,
              <span class="kw">aes</span>(<span class="dt">x=</span><span class="fl">1.2</span>, <span class="dt">y=</span>count, <span class="dt">label=</span>percent),
              <span class="dt">position=</span><span class="kw">position_stack</span>(<span class="dt">vjust=</span><span class="fl">0.5</span>))</code></pre></div>
</section>
<section id="solving-the-mystery" class="level2">
<h2>Solving the mystery</h2>
<p>So let us try to now answer the question on why diamonds with worse color/clarity are actually more expensive. The answer lies in the effect of the diamond size (carat) on the price: Bigger diamonds are more expensive but also harder to get in the best color/clarity.</p>
<p>So we would like to condition on the size as we examine the relationship between price and color. In order to do that we would need to “bin” the <code>carat</code> variable to turn into a categorical variable. We can use one of the <code>cut_</code> methods for this:</p>
<ul>
<li><code>cut_interval</code> lets you specify how many bins to use.</li>
<li><code>cut_width</code> lets you specify how wide the bins will be.</li>
<li><code>cut_number</code> lets you specify a uniform bin frequency.</li>
</ul>
<p>First let us restrict the carat range to exclude outliers. Here is the carat range:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(diamonds, <span class="kw">aes</span>(<span class="dt">x=</span>carat)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">bins=</span><span class="dv">40</span>)</code></pre></div>
<p>We will restrict to diamonds up to 2.5 carats. Let us look at how these are distributed amongst the different colors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(carat <span class="op">&lt;=</span><span class="st"> </span><span class="fl">2.5</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>carat, <span class="dt">fill=</span>color)) <span class="op">+</span>
<span class="st">        </span><span class="kw">geom_density</span>() <span class="op">+</span>
<span class="st">        </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette=</span><span class="st">&quot;Blues&quot;</span>)</code></pre></div>
<p>This graph shows us the overlapping density curves for each color. A better view will stack the curves:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(carat <span class="op">&lt;=</span><span class="st"> </span><span class="fl">2.5</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>carat, <span class="dt">fill=</span>color)) <span class="op">+</span>
<span class="st">        </span><span class="kw">geom_density</span>(<span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">        </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette=</span><span class="st">&quot;Blues&quot;</span>)</code></pre></div>
<p>We can see from this graph that most of the best color diamonds are small.</p>
<p><strong>Practice</strong>: What if we used clarity instead of color?</p>
<p>Now we will facet the graph based on a carat grouping, using the <code>cut_interval</code> method:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(carat <span class="op">&lt;=</span><span class="st"> </span><span class="fl">2.5</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price)) <span class="op">+</span>
<span class="st">        </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">cut_interval</span>(carat, <span class="dv">6</span>))</code></pre></div>
<p>The vast difference in value ranges on the various panels makes it hard to clearly see the patterns. To that end, we would like to set each panel to have independent scales:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(carat <span class="op">&lt;=</span><span class="st"> </span><span class="fl">2.5</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>color, <span class="dt">y=</span>price)) <span class="op">+</span>
<span class="st">        </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">cut_interval</span>(carat, <span class="dv">6</span>), <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre></div>
</section>
</section>
</body>
</html>
